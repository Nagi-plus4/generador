<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nagi+ Player</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide@latest/dist/lucide.css">
    <style>
        body {
            margin: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        .player-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: #000;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
        .controls {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 10px;
            display: flex;
            flex-direction: column;
            opacity: 1;
            transition: opacity 0.3s;
        }
        .controls.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .top-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.2em;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 10px;
            display: none;
        }
        .button {
            background: rgba(0,0,0,0.5);
            border: none;
            color: #fff;
            margin: 2px;
            padding: 5px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .progress-bar {
            flex: 1;
            appearance: none;
            height: 5px;
            background: #444;
            border-radius: 5px;
        }
        .progress-bar::-webkit-slider-thumb {
            appearance: none;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
        }
        .intro-btn, .lock-btn, .unlock-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .hidden-absolute {
            display: none;
        }
    </style>
</head>
<body>

<div class="player-container" id="player">
    <video id="video" poster="">
        <track id="subtitles" label="Español" kind="subtitles" srclang="es" default>
    </video>

    <div class="loading-spinner" id="loading">Cargando Nagi+...</div>

    <div class="top-bar" id="title">Título del episodio</div>

    <button class="intro-btn hidden-absolute" id="skipIntro">Saltar intro</button>
    <button class="lock-btn" id="lock"><i data-lucide="lock"></i></button>
    <button class="unlock-btn hidden-absolute" id="unlock"><i data-lucide="unlock"></i></button>

    <div class="controls" id="controls">
        <div style="display: flex; justify-content: space-between;">
            <button class="button" id="rewind"><i data-lucide="rotate-ccw"></i></button>
            <button class="button" id="playPause"><i data-lucide="play"></i></button>
            <button class="button" id="forward"><i data-lucide="rotate-cw"></i></button>
            <button class="button" id="fitMode"><i data-lucide="maximize"></i></button>
            <button class="button" id="fullscreen"><i data-lucide="maximize-2"></i></button>
        </div>

        <div class="progress-container">
            <span id="currentTime">00:00</span>
            <input type="range" id="progress" class="progress-bar" min="0" max="100" value="0">
            <span id="duration">00:00</span>
        </div>

        <div style="display: flex; justify-content: space-between;">
            <button class="button" id="episodes">Episodios</button>
            <button class="button" id="nextEpisode">Sig. Episodio</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    // Parámetros configurables
    const linkmp4 = "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8"; // URL MP4 o M3U8
    const poster = "https://via.placeholder.com/1280x720.png?text=Portada+Nagi+Player";
    const titulo = "Episodio 1 - Nagi Player";
    const intro = 90; // Segundos hasta donde saltar intro
    const sig = "siguiente.html"; // URL siguiente episodio
    const capitulos = "episodios.html"; // URL lista de episodios
    const subtitlesURL = ""; // Opcional: URL de subtítulos .vtt

    // Elementos
    const video = document.getElementById('video');
    const controls = document.getElementById('controls');
    const playPauseBtn = document.getElementById('playPause');
    const rewindBtn = document.getElementById('rewind');
    const forwardBtn = document.getElementById('forward');
    const progress = document.getElementById('progress');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const loading = document.getElementById('loading');
    const skipIntroBtn = document.getElementById('skipIntro');
    const lockBtn = document.getElementById('lock');
    const unlockBtn = document.getElementById('unlock');
    const fitModeBtn = document.getElementById('fitMode');
    const fullscreenBtn = document.getElementById('fullscreen');
    const nextEpisodeBtn = document.getElementById('nextEpisode');
    const episodesBtn = document.getElementById('episodes');
    const subtitlesTrack = document.getElementById('subtitles');

    // Configuración inicial
    video.poster = poster;
    document.getElementById('title').textContent = titulo;
    if (subtitlesURL) {
        subtitlesTrack.src = subtitlesURL;
    } else {
        subtitlesTrack.remove();
    }

    // Cargar video
    if (linkmp4.endsWith('.m3u8')) {
        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(linkmp4);
            hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = linkmp4;
        } else {
            alert("Tu navegador no soporta streaming HLS");
        }
    } else {
        video.src = linkmp4;
    }

    // Mostrar loading
    video.addEventListener('waiting', () => loading.style.display = 'block');
    video.addEventListener('canplay', () => loading.style.display = 'none');

    // Reanudar progreso
    const savedTime = localStorage.getItem(linkmp4);
    if (savedTime) video.currentTime = savedTime;

    // Guardar progreso
    setInterval(() => localStorage.setItem(linkmp4, video.currentTime), 1000);

    // Play/Pause
    playPauseBtn.onclick = () => {
        if (video.paused) {
            video.play();
            playPauseBtn.innerHTML = '<i data-lucide="pause"></i>';
        } else {
            video.pause();
            playPauseBtn.innerHTML = '<i data-lucide="play"></i>';
        }
        lucide.createIcons({ replace: true });
    };

    // Rewind/FastForward
    rewindBtn.onclick = () => video.currentTime -= 10;
    forwardBtn.onclick = () => video.currentTime += 10;

    // Progress
    video.ontimeupdate = () => {
        progress.value = (video.currentTime / video.duration) * 100;
        currentTimeEl.textContent = formatTime(video.currentTime);
        durationEl.textContent = formatTime(video.duration);

        // Mostrar botón saltar intro
        if (video.currentTime <= intro) {
            skipIntroBtn.classList.remove('hidden-absolute');
        } else {
            skipIntroBtn.classList.add('hidden-absolute');
        }
    };
    progress.oninput = () => video.currentTime = (progress.value / 100) * video.duration;

    // Saltar intro
    skipIntroBtn.onclick = () => {
        video.currentTime = intro;
        skipIntroBtn.classList.add('hidden-absolute');
    };

    // Fullscreen
    fullscreenBtn.onclick = () => {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    };

    // Ajustar fit/cover
    fitModeBtn.onclick = () => {
        video.style.objectFit = (video.style.objectFit === 'cover') ? 'contain' : 'cover';
    };

    // Bloquear controles
    lockBtn.onclick = () => {
        controls.classList.add('hidden');
        lockBtn.classList.add('hidden-absolute');
        unlockBtn.classList.remove('hidden-absolute');
    };
    unlockBtn.onclick = () => {
        controls.classList.remove('hidden');
        lockBtn.classList.remove('hidden-absolute');
        unlockBtn.classList.add('hidden-absolute');
    };

    // Redirigir
    nextEpisodeBtn.onclick = () => location.href = sig;
    episodesBtn.onclick = () => location.href = capitulos;

    // Ocultar controles tras 3 seg
    let hideTimeout;
    const showControls = () => {
        controls.classList.remove('hidden');
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => controls.classList.add('hidden'), 3000);
    };
    document.getElementById('player').onclick = showControls;

    // Helpers
    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }

    // Render íconos
    lucide.createIcons({ replace: true });
</script>
</body>
</html>
